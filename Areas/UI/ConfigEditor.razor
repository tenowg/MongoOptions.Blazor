@typeparam T where T : class, new()
@using System.Reflection
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq.Expressions

<EditForm FormName="ConfigEditor" EditContext="editContext" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary  />
 
    <div class="card p-3">
        <div class="mb-3">
            <label class="form-label">Configuration Name</label>
            <InputText @bind-Value="ConfigName" class="form-control" placeholder="e.g. Default or Tenant_A" />
        </div>
        <CascadingValue Value="messageStore">
            <ValueEditor SettingsObject="SettingsObject" />
        </CascadingValue>
        
        <button type="submit" class="btn btn-primary">Save Configuration</button>
    </div>
</EditForm>

@code {
    [Parameter] public T SettingsObject { get; set; } = new();
    [Parameter] public string ConfigName { get; set; } = "Default";
    [Parameter] public EventCallback<(string Name, T Value)> OnSave { get; set; }
    [Parameter] public bool isSubClass { get; set; } = false;

    private EditContext? editContext;
    private ValidationMessageStore? messageStore;

    protected override void OnInitialized()
    {
        editContext = new EditContext(SettingsObject);
        messageStore = new ValidationMessageStore(editContext);

        editContext.OnFieldChanged += (s, e) => messageStore.Clear(e.FieldIdentifier);
        
    }

    private async Task HandleValidSubmit()
    {
        await OnSave.InvokeAsync((ConfigName, SettingsObject));
    }
}
